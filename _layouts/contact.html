---
layout: default
---

{%- if site.google.recaptcha.pubkey and site.google.apps_script.url -%}

<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<div class="container contact">
  <div class="modal fade"
  id="contactMessageModal"
  tabindex="-1"
  aria-labelledby="contactMessageModalLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contactMessageModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body"></div>
      </div>
    </div>
  </div>

  <div class="row">
    <span class="contact-title"><strong>[&nbsp;{{ page.title | downcase }}&nbsp;]</strong></span>
    <form id="contactForm" class="mt-4 contact-form">
      <div class="mb-3">
        {% comment %} <label for="inputName" class="form-label">{{ site.strings.contact.name | default: "Name" | downcase }}</label> {% endcomment %}
        <input id="inputName"
        name="name"
        type="text"
        placeholder="{{ site.strings.contact.name.placeholder | default: 'First and last name' }}"
        class="form-control contact-form__name"
        required>
      </div>
      <div class="mb-3">
        {% comment %} <label for="inputEmail" class="form-label">{{ site.strings.contact.name | default: "Email address" | downcase }}</label> {% endcomment %}
        <input id="inputEmail"
        name="email"
        type="email"
        placeholder="{{ site.strings.contact.email.placeholder | default: 'Your best email address' }}"
        class="form-control contact-form__email"
        aria-describedby="emailHelp"
        required>
        <div id="emailHelp" class="form-text contact-form__help">
          {{ site.strings.contact.email.help | default: "We'll never share your email with anyone else." }}
        </div>
      </div>
      <textarea id="textMessage"
      name="message"
      class="form-control contact-form__message"
      placeholder="{{ site.strings.contact.message.placeholder | default: 'Write your message here' }}"
      style="min-height: 150px"
      required></textarea>
      <small style="display: block; font-size: 8pt; opacity: .6">{{ site.strings.contact.message.caracters.warning.content }}</small>
      <!-- TODO: version: 0.2.0 Make reCaptcha change themes instantly -->
      <div id="g-recaptcha" class="g-recaptcha mt-2" data-sitekey="{{ site.google.recaptcha.pubkey }}" style="display: inline-block; margin: 5px 0;"></div>
      <div class="d-flex justify-content-end mb-5">
        <button id="submitButton"
        type="submit"
        class="btn contact-form__submit">
        {{ site.strings.contact.button.text | default: 'Send!' }}
        </button>
      </div>
    </form>
  </div>
  <div class="row">
    <div class="contact-content">{{ content }}</div>
  </div>
</div>

<script>
  const form = document.getElementById("contactForm");
  const submitButton = document.getElementById("submitButton");
  const endpoint = "{{ site.google.apps_script.url }}"; // URL Google Apps Script

  // get modal
  function showModal(title, message, type = 'success') {
    const modalEl = document.getElementById('contactMessageModal');
    const modalTitle = modalEl.querySelector('.modal-title');
    const modalBody = modalEl.querySelector('.modal-body');
    const modalContent = modalEl.querySelector('.modal-content');

    modalContent.classList.remove('contact-message-success', 'contact-message-error', 'contact-message-warning');


    // Apply the color according to the type
    if (type === 'success') {
      modalContent.classList.add('contact-message-success');
    } else if (type === 'error') {
      modalContent.classList.add('contact-message-error');
    } else if (type === 'warning') {
      modalContent.classList.add('contact-message-warning');
    }

    modalTitle.innerHTML = title;
    modalBody.innerHTML = message;

    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const recaptchaResponse = grecaptcha.getResponse();
    if (!recaptchaResponse) {
      showModal(
        "{{ site.strings.contact.recaptcha.warning.title | default: 'Warning' }}",
        "{{ site.strings.contact.recaptcha.warning.content | default: "Please tick the 'I'm not a robot' box." }}",
        "warning"
      );
      return;
    }

    const textarea = document.getElementById('textMessage');
    const text = textarea.value.trim();
    if (text.length < {{ site.strings.contact.message.caracters.min }}) {
      showModal(
        "{{ site.strings.contact.message.caracters.warning.title | default: 'Warning' }}",
        "{{ site.strings.contact.message.caracters.warning.content | default: "The message must have at least 50 characters." }}",
        "warning"
      );
      return;
    }

    submitButton.disabled = true;
    submitButton.textContent = "{{ site.strings.contact.message.status | default: "Sending...Wait" }}";

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch(endpoint, {
        method: "POST",
        redirect: "follow",
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.result === 'success') {
        form.reset();
        grecaptcha.reset();
        showModal(
          "{{ site.strings.contact.message.success.title | default: 'Message Sent' }}",
          "{{ site.strings.contact.message.success.content | default: 'Your message has been sent successfully!' }}",
          "success"
        );
      } else {
        showModal(
          "{{ site.strings.contact.message.error.title | default: 'Error' }}",
          "{{ site.strings.contact.message.error.content | default: 'Something went wrong while sending your message.' }}",
          "error"
        );
        throw new Error(result.message || "{{ site.strings.contact.message.error.content | default: "An unknown error has occurred." }}");
      }

    } catch (error) {
      console.error("Error sending:", error);
      if (error.message.includes("reCAPTCHA")) {
          showModal(
            "{{ site.strings.contact.message.error.title | default: 'Error' }}",
            "{{ site.strings.contact.recaptcha.fail | default: "Verification failed. Please reload the page and try again." }}",
            "error"
          );
      } else {
          showModal(
            "{{ site.strings.contact.message.error.title | default: 'Error' }}",
            "{{ site.strings.contact.recaptcha.error | default: "An error occurred while sending the message. Please try again." }}",
            "error"
          );
      }
      grecaptcha.reset();

    } finally {
      submitButton.disabled = false;
      submitButton.textContent = "{{ site.strings.contact.button.text | default: "Send!" }}";
    }
  });
</script>
{%- else -%}

<div class="contat-disabled">
  <h1 style="background-color: yellow;color: black;padding: 10px">Warning: Email form disabled</h1>
  <p>To use the email submission form, you need to:</p>
  <p>1 - Copy the script below and implement it in <a href="https://script.google.com" target="_blank">Google Apps Script</a>:</p>
  <blockquote>
    <p>Note1: Don't forget to put your gmail in the script.</p>
    <p>Note2: Without editing the script in Google Apps Script, you need to deploy it again.</p>
  </blockquote>

{% highlight javascript linenos %}
// IMPORTANT! You must put your gmail email here.
const TO_ADDRESS = "YOUR EMAIL GMAIL";

// Get the secret key from the Script Properties
const RECAPTCHA_SECRET_KEY = PropertiesService.getScriptProperties().getProperty('RECAPTCHA_SECRET_KEY');

// Function to validate the reCAPTCHA token
function validateRecaptcha(token) {
  if (!token) {
    throw new Error("Missing reCAPTCHA token.");
  }
  const url = "https://www.google.com/recaptcha/api/siteverify";
  const payload = {
    secret: RECAPTCHA_SECRET_KEY,
    response: token
  };

  const response = UrlFetchApp.fetch(url, {
    method: "post",
    payload: payload
  });

  const result = JSON.parse(response.getContentText());

  if (!result.success) {
    throw new Error("reCAPTCHA verification failed: " + (result['error-codes'] || 'Unknown error.'));
  }

  return true;
}


function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);

    // 1. Validate the reCAPTCHA token first!
    validateRecaptcha(data['g-recaptcha-response']);

    // 2. If validation passed, continue with the rest of the code
    const { name, email, message } = data;

    if (!name || !email || !message) {
      throw new Error("Missing form data.");
    }

    const subject = "New website message " + name;
    const htmlBody = `
      <p>You have received a new message from your website.:</p><hr>
      <p><b>Name:</b> ${name}</p>
      <p><b>Email:</b> <a href="mailto:${email}">${email}</a></p>
      <p><b>Message:</b></p>
      <p style="white-space: pre-wrap;">${message}</p><hr>
    `;

    MailApp.sendEmail({
      to: TO_ADDRESS,
      subject: subject,
      htmlBody: htmlBody,
      replyTo: email
    });

    return ContentService
      .createTextOutput(JSON.stringify({ 'result': 'success', 'message': 'Message sent!' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log(err.toString());
    return ContentService
      .createTextOutput(JSON.stringify({ 'result': 'error', 'message': err.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
{% endhighlight %}
  <p>2 - Create a <a href="https://console.cloud.google.com/security/recaptcha" target="_blank">reCaptcha</a>
  on Google and add the reCaptcha <strong>PRIVATE</strong> key to the <strong>Google Apps Script</strong> script property.</p>
  <p>3 - Copy the reCaptcha <strong>PUBLIC</strong> key and the <strong>Google Apps Script</strong> URL and place them in <strong>_config.yml:</strong></p>
  {% highlight yml linenos %}
google:
  ###
  ###
  apps_script:
    url: "https://script.google.com/macros/s/BuD..."
  recaptcha:
    pubkey: "8Lci194rAAAAA70Sv..."
  {% endhighlight %}
</div>
{%- endif -%}
