<!-- Theme for Jekyll.rb by: © William C. Canin -->
{%- if site.maintenance.enable -%}
  {%- include layout/maintenance.html -%}
{%- else -%}

{%- include layout/data.liquid -%}

{%- assign index = site.pages | where: "path", "index.md" | first -%}

<!DOCTYPE html>
<html id="top" lang="{{ site.lang | default: 'en' }}" data-theme="light">
  {%- include layout/head.html -%}
  <body data-layout="{{ page.layout | default: '' }}" data-terminal-enabled="{{ site.home.terminal.enable | default: false }}">
    {%- if site.home.terminal.enable and page.url == "/" and index.layout == "home" -%}
      <div class="default default-terminal" style="max-width: {{ site.layout.width | default: '780px' }} !important;">
        {%- include layout/header.html -%}
      </div>
      <main class="content">{{ content }}</main>
      {%- include layout/footer.html -%}
    {%- else -%}
      <div class="default" style="max-width: {{ site.layout.width | default: '780px' }} !important;">
        {%- include layout/header.html -%}
        <main class="content">{{ content }}</main>

        {%- include layout/footer.html -%}
      </div>
    {%- endif -%}
  </body>

  <!-- Scripts -->
  <script src="{{ '/assets/vendor/bootstrap/js/bootstrap.bundle.min.js' | relative_url }}"></script>

  {%- if page.comments != false and site.blog.post.comments.provider == 'giscus' -%}
  <script>
    window.giscusThemes = {
      light: "{{ site.blog.post.comments.giscus.theme_light | default: 'light' }}",
      dark: "{{ site.blog.post.comments.giscus.theme_dark | default: 'dark' }}"
    };
  </script>
  {%- endif -%}

  <script src="{{ '/assets/js/default.js' | relative_url }}"></script>

  {%- if page.url == '/' and site.home.terminal.enable -%}
    <script src="{{ '/assets/js/terminal.js' | relative_url }}"></script>
  {%- endif -%}

  {%- if site.avatar.open -%}
    <script src="{{ '/assets/js/avatar.js' | relative_url }}"></script>
  {%- endif -%}

  {%- if site.blog.search.enable -%}
    {%- if page.url == '/blog/' or page.url == '/blog/index.html' -%}
      <script src="{{ '/assets/vendor/simple-jekyll-search.min.js' | relative_url }}"></script>



      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const btn = document.getElementById('blog-search__btn');
          const box = document.querySelector('.blog-search');
          const searchInput = document.getElementById('blog-search__input');
          const blogPosts = document.getElementById('posts');
          const searchResults = document.getElementById('blog-search__results');
          const searchResultsWrapper = document.getElementById('blog-search__results-wrapper');
          const btnSearchClean = document.getElementById('blog-search__btn-clean');
          const blogSeachInput = document.getElementById('blog-search__input');


          if (!btn || !box) return;

          const openSearch = () => {
            box.classList.add('is-open');
            box.removeAttribute('inert');
            box.style.maxHeight = box.scrollHeight + 'px';
            box.style.opacity = '1';
            box.addEventListener('transitionend', function onOpened(e) {
              if (e.propertyName === 'max-height') {
                box.style.maxHeight = 'none';
                box.removeEventListener('transitionend', onOpened);
              }
            });
            blogSeachInput.focus();
          };

          const closeSearch = () => {
            box.style.maxHeight = box.scrollHeight + 'px';
            void box.offsetHeight; // reflow force
            requestAnimationFrame(() => {
              box.style.maxHeight = '0';
              box.style.opacity = '0';
            });
            box.setAttribute('inert', '');
            box.classList.remove('is-open');
          };

          btn.addEventListener('click', (e) => {
            e.preventDefault();

            // if are already in /blog/, toggle
            const pathname = location.pathname.replace(/\/$/, '');
            const isBlog = pathname === '/blog' || pathname === '/blog/index.html';

            if (!isBlog) {
              // if are on another page, go to /blog/ and open it
              window.location.href = "{{ search_url }}";
              return;
            }

            // toggle
            if (box.classList.contains('is-open')) {
              closeSearch();
              searchInput.value = '';
              blogPosts.classList.remove('disabled');
              searchResultsWrapper.classList.add('disabled');
            } else {
              openSearch();
            }
          });

          // opens automatically if arrived from another link with ?search=open
          const params = new URLSearchParams(location.search);
          if (params.get('search') === 'open') {
            setTimeout(openSearch, 30);
          }

          /* clean button input blog search
          --------------------------------------------------------------------------------------------------
          */
          function clearSearch() {
            blogSeachInput.value = '';
            blogPosts.classList.remove('disabled');
            searchResults.classList.add('disabled');
            searchResultsWrapper.classList.add('disabled');
            blogSeachInput.focus();
          }
          btnSearchClean.addEventListener('click', clearSearch);
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              clearSearch();
              closeSearch();
            }
          });

          /* open results and close posts in search (toggle)
          --------------------------------------------------------------------------------------------------
          */
          searchInput.addEventListener('input', () => {
            if (searchInput.value.trim().length > 0) {
              blogPosts.classList.add('disabled');
              searchResults.classList.remove('disabled');
              searchResultsWrapper.classList.remove('disabled');
            } else {
              blogPosts.classList.remove('disabled');
              searchResults.classList.add('disabled');
              searchResultsWrapper.classList.add('disabled');
            }
          });
          var sjs = SimpleJekyllSearch({
            searchInput: document.getElementById('blog-search__input'),
            resultsContainer: document.getElementById('blog-search__results'),
            searchResultTemplate: '<li><span class="blog-list__meta"><time datetime="{date}">{date}</time></span>&nbsp;»&nbsp; <a class="blog-list__link" href="{{ site.url }}{url}">{title}</a></li>',
            noResultsText: '<p>{{ site.strings.blog.no_results | default: "No results found" }}</p>',
            json: "{{ '/assets/json/blog_search.json' | relative_url }}"
          })
        });
      </script>
    {%- endif -%}
  {%- endif -%}

  {%- if site.home.terminal.enable and page.url == "/" -%}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const screen = document.getElementById('screen');
      const terminal = document.getElementById("terminal");
      const socialsEl = document.getElementById("terminal-screen--socials");

      const commands = {
        help: `{{ site.strings.home.terminal.commands }}`,
        about: document.getElementById("home-content").innerHTML,
        socials: socialsEl ? socialsEl.innerHTML : `{{ site.strings.home.terminal.no_socials }}`,
      };

      function createInputLine() {
        const line = document.createElement('div');
        line.className = 'line';

        const prompt = document.createElement('span');
        prompt.className = 'prompt';
        prompt.textContent = `$`;

        // wrapper para conter input, cursor e measure
        const wrapper = document.createElement('span');
        wrapper.className = 'input-wrapper';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'input';
        input.placeholder = `{{ site.strings.home.terminal.welcome }}`;
        input.spellcheck = false;
        input.autocomplete = 'off';
        input.autocorrect = 'off';
        input.autocapitalize = 'off';

        const cursor = document.createElement('span');
        cursor.className = 'cursor';

        const measure = document.createElement('span');
        measure.className = 'measure';

        wrapper.appendChild(input);
        wrapper.appendChild(cursor);
        wrapper.appendChild(measure);

        line.appendChild(prompt);
        line.appendChild(wrapper);
        screen.appendChild(line);

        input.focus();
        screen.scrollTop = screen.scrollHeight;

        // Updates the fake cursor position based on the input's selectionStart
        function updateCursor() {
          const sel = input.selectionStart || 0;
          // measure the text to the position of the caret
          measure.textContent = input.value.slice(0, sel);
          const textWidth = measure.offsetWidth; // largura do texto sem scroll
          const visibleLeft = textWidth - input.scrollLeft;
          cursor.style.left = visibleLeft + 'px';

          // ensure the caret is visible (for long texts): adjust input's scrollLeft
          const paddingRight = 10;
          if (textWidth - input.scrollLeft > input.clientWidth - paddingRight) {
            input.scrollLeft = textWidth - input.clientWidth + paddingRight;
            cursor.style.left = (textWidth - input.scrollLeft) + 'px';
          } else if (textWidth < input.scrollLeft) {
            input.scrollLeft = textWidth;
            cursor.style.left = (textWidth - input.scrollLeft) + 'px';
          }
        }

        // show/hide cursor animation as focus changes
        function onFocus() { cursor.style.opacity = '1'; updateCursor(); }
        function onBlur()  { cursor.style.opacity = '0'; }

        input.addEventListener('input', updateCursor);
        input.addEventListener('keydown', (e) => {
          // Update position on keys that do not trigger input immediately (arrows, delete, etc.)
          setTimeout(updateCursor, 0);

          if (e.key === 'Enter') {
            e.preventDefault();
            const cmd = input.value.trim().toLowerCase();
            if (cmd) {
              // remove input/cursor/measure and place fixed text
              wrapper.removeChild(input);
              wrapper.removeChild(cursor);
              wrapper.removeChild(measure);
              const cmdText = document.createElement('span');
              cmdText.textContent = cmd;
              wrapper.appendChild(cmdText);
              processCommand(cmd);
            } else {
              // if you enter without command, it just creates a new empty line (with prompt)
              wrapper.removeChild(input);
              wrapper.removeChild(cursor);
              wrapper.removeChild(measure);
              const blank = document.createElement('span');
              blank.textContent = '';
              wrapper.appendChild(blank);
            }
            // New linr input
            createInputLine();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            screen.innerHTML = '';
            createInputLine();
          }
        });

        // arrows, mouse click, mouseup (position caret), etc.
        input.addEventListener('keyup', updateCursor);
        input.addEventListener('click', () => {
          // updates after click (selectionStart already set)
          setTimeout(updateCursor, 0);
        });
        input.addEventListener('mouseup', () => setTimeout(updateCursor, 0));
        input.addEventListener('focus', onFocus);
        input.addEventListener('blur', onBlur);

        updateCursor();
      }

      // processes commands
      function processCommand(cmd) {
        switch(true){
          case cmd === 'help': commandsPrint(commands.help, mode='html'); break;
          case cmd === 'date': commandsPrint(new Date().toString(), mode='text'); break;
          // case cmd.startsWith('echo '): commandsPrint(cmd.split(' ').slice(1).join(' ')); break;
          case cmd === 'about': writeLineHTML(commands.about); break;
          case cmd === 'socials': writeLineHTML(commands.socials); break;
          case cmd === 'clear': screen.innerHTML=''; break;
          default: if(cmd) commandsPrint(cmd + `{{ site.strings.home.terminal.error }}`, mode='text');
        }
      }

      function writeLineHTML(content, mode = 'html') {
        const wrapper = document.createElement('div');
        wrapper.className = 'line-wrapper';

        if (mode === 'html') {
          wrapper.innerHTML = content;
        } else {
          wrapper.textContent = content;
        }
        screen.appendChild(wrapper);
        screen.scrollTop = screen.scrollHeight;
      }

      function commandsPrint(text, mode = 'html') {
        // creates the wrapper to group all the lined
        const wrapper = document.createElement('div');
        wrapper.className = 'line-wrapper';

        text.split('\n').forEach((t) => {
          const line = document.createElement('div');
          line.className = 'line';
          if (mode === 'html') {
            line.innerHTML = t;
          } else {
            line.textContent = t;
          }
          wrapper.appendChild(line);
        });

        screen.appendChild(wrapper);
        screen.scrollTop = screen.scrollHeight;
      }

      // start terminal
      createInputLine();

      // when clicking on the terminal, it always focuses on the last existing input
      terminal.addEventListener("click", (e) => {
        // avoids focusing when clicking a header button, etc.
        const lastInput = screen.querySelector('.input:last-of-type');
        if (lastInput) lastInput.focus();
      });
    });
  </script>
  {%- endif -%}
</html>
{%- endif -%}
